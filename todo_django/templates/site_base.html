<!DOCTYPE html>
<html>
<head>
    <link href="http://css.nlx.org/framework/v2/css/def.ui.css"
        rel="stylesheet" type="style/css">
    <title>IndyPy: Web Shootout</title>
    <style>
    .topbar a{
        color: #fff;
    }
    .topbar .menu{
        margin-top: 5px;
    }
    .topbar .menu a{
        vertical-align: middle;
        border: 1px solid #ccc;
        border-top-width: 0px;
        border-bottom-width: 0px;
        padding: 5px;
    }
    .topbar .menu a + a{
        margin-left: -5px;
    }
    .topbar .menu a:hover{
        color: #000;
        background: #ccc;
    }
    .loginBox, .formBox{
        background-color: #fff;
        padding: 10px;
        padding-bottom: 30px;
        border: 2px solid #574E44;
        border-radius: 5px;
        }
    .formBox + .formBox{
        margin-top: 20px;
    }
    .formBox h2{
        background: #999;
        color: #fff;
        margin: -10px -10px 10px -10px;
        padding: 6px 5px 5px 5px;
    }
    .span5 .control-label{
        width: 100px;
    }
   .span5 .controls{
        margin-left: 120px;
    }
    a.label-info:hover{
        color: #000;
        text-shadow: none;
        background: #7ac7ed;
    }
    </style>
    {% block extra_header %}{% endblock extra_header %}
</head>
<body>
    {% block topbar %}
    <div class="topbar" data-dropdown="dropdown">
        <div class="topbar-inner">
            <div class="wrapper">
                <div class="row">
                    <div class="span3" id="logo-block">
                        <a href="/">
                           <h3 class="pull-left">Direct Employers</h3>
                        </a>
                    </div>
                    <div class="span8">
                        <div class="menu">
                        {% if user.is_authenticated %}
                            <a href="/profile/">{{user}}'s Tasks</a>
                            <a href="/profile/tags/">Tags</a>
                            <a id="task_export" href="/export/">Task Export</a>
                        {% endif %}
                        </div>
                    </div>
                    <div class="span1">
                        <div  class="text-right">
                        {% if user.is_authenticated %}
                            <form action="/logout/" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="next" value="/"/>
                                <input type="submit" value="logout" class="btn primary"/>
                            </form>
                        {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endblock topbar %}
    {% block body %}{% endblock body %}
    {% block main_js %}
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"></script>
    <!-- This is totally an evil hack. Need to set this up as a django static file -->
    <script src="https://raw.github.com/PolicyStat/jquery-celery/master/src/celery.js"></script>
    <script>
        $(document).ready(function() {
            $("#task_export").live('click', function (e) {
                var $this = $(this),
                    exportUrl = $this.attr("href"),
                    originalHtml = $this.clone(),
                    progressHtml;

                    progressHtml = [
                        '<div class="progress_container">',
                            '<div class="time_remaining">Waiting for Report Runner</div>',
                            '<div class="progress progress-striped">',
                                '<div class="bar" style="width: 0%"></div>',
                            '</div>',
                        '</div>'
                    ].join('\n');

                    $this.replaceWith(progressHtml);

                    // Handler in case something goes wrong with the celery
                    // task
                    function error() {
                        var msg = '<p class="error">There was an error generating your report.</p>';
                        $('.progress_container').replaceWith(msg);
                    }

                    // First, just get the task_id for the Celery task that
                    // will be building the export
                    $.getJSON(exportUrl, function(data) {
                        // Use djcelery to redirect to the CSV file once the
                        // task completes
                        $('.loading').djcelery({
                            task_id: data['task_id'],
                            check_interval: 2000,
                            on_success: function (task) {
                                // Redirect to export page with the task id
                                var newUrl = exportUrl  + task.id + '/';

                                // And replace the link to the export
                                $('.progress_container').replaceWith(originalHtml);

                                setTimeout(function() {
                                    window.location = newUrl;
                                }, 1000);
                            },
                            on_failure: error,
                            on_error: error,
                            on_other: function(task_result) {
                                var $progress_container = $('.progress_container'),
                                    $time_remaining = $progress_container.find('.time_remaining'),
                                    $progress_bar = $progress_container.find('.progress .bar');
                                if (task_result.status == 'PROGRESS') {
                                    // Set the percentage
                                    var percent = task_result.result.progress_percent;
                                    $progress_bar.css('width', percent + '%');

                                    // Set time remaining
                                    time_remaining = task_result.result.time_remaining;
                                    if (time_remaining > 0) {
                                        $time_remaining.html(
                                            'Approximate time left: ' + Math.round(time_remaining) + ' seconds'
                                        );
                                    }
                                }
                            }
                        });
                    });

                return false;
            });
        });
    </script>
    {% endblock main_js %}
    {% block extra_js %}{% endblock extra_js %}
</body>
</html>
